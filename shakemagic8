import logging
import random
import os
from io import BytesIO
from PIL import Image, ImageDraw, ImageFont
from telegram import Update, InputFile
from telegram.ext import Updater, CommandHandler, MessageHandler, CallbackContext
from dotenv import load_dotenv

# Load environment variables from .env file
load_dotenv()

# Enable logging
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Define the responses
responses = ["Yes", "No", "Maybe"]

# Function to overlay a vector image
def overlay_vector_image(base_image: Image, vector_image_path: str) -> Image:
    vector_img = Image.open(vector_image_path).convert("RGBA")
    base_image.paste(vector_img, (0, 0), vector_img)
    return base_image

# Function to generate the response image
def generate_response_image(user_image: BytesIO, vector_image_path: str) -> BytesIO:
    # Load the user image
    user_img = Image.open(user_image).convert("RGBA")

    # Overlay the vector image
    user_img = overlay_vector_image(user_img, vector_image_path)

    # Create a draw object
    draw = ImageDraw.Draw(user_img)

    # Choose a random response
    response = random.choice(responses)

    # Load a font
    font = ImageFont.load_default()

    # Add the response text to the image
    text_position = (10, user_img.height - 20)  # Bottom left corner
    draw.text(text_position, response, font=font, fill="white")

    # Save the modified image to a BytesIO object
    output_image = BytesIO()
    user_img.save(output_image, format='PNG')
    output_image.seek(0)

    return output_image

# Command handler for /shake8ball
def shake8ball(update: Update, context: CallbackContext) -> None:
    user = update.message.from_user
    logger.info("User %s initiated /shake8ball", user.first_name)
    
    # Send a message to ask for a yes/no question
    update.message.reply_text('Please send me a yes/no question followed by an image.')

# Message handler for images
def handle_image(update: Update, context: CallbackContext) -> None:
    user = update.message.from_user
    logger.info("User %s sent an image", user.first_name)
    
    # Get the image file
    photo = update.message.photo[-1].get_file()
    photo_file = BytesIO(photo.download_as_bytearray())

    # Path to the vector image (ensure this path is correct)
    vector_image_path = "overlay.png"

    # Generate the response image
    response_image = generate_response_image(photo_file, vector_image_path)

    # Send the response image back to the user
    update.message.reply_photo(photo=InputFile(response_image, filename="response.png"))

def main() -> None:
    # Get the bot token from the environment variable
    token = os.getenv("TELEGRAM_BOT_TOKEN")
    if not token:
        logger.error("TELEGRAM_BOT_TOKEN environment variable not set")
        return
    
    # Create the Updater and pass it your bot's token.
    updater = Updater(token)

    # Get the dispatcher to register h
